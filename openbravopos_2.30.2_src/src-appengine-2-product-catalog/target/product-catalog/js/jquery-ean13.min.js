/*
* Copyright (c) 2014 Johannes Mittendorfer (http://johannes-mittendorfer.com)
* Licensed under the MIT License (LICENSE.txt).
*
* Version 2.1.1
* Build 2014-10-07
*/

!function(a){var b,c;return c="EAN13",b=function(){function b(a,b,d){var e;if(this.element=a,this.number=b,this.settings={number:!0,prefix:!0,color:"#000",debug:!1,onValid:function(){},onInvalid:function(){},onSuccess:function(){},onError:function(){}},d)for(e in d)this.settings[e]=d[e];this._name=c,this.init()}return b.prototype.settings={},b.prototype.init=function(){var a,b;return 12===this.number.length&&(a=this.generateCheckDigit(this.number),this.number+=a),13===this.number.length?(this.validate()?this.settings.onValid.call():this.settings.onInvalid.call(),b=this.getCode(),this.draw(b)):this.settings.onError.call()},b.prototype.getCode=function(){var a,b,c,d,e,f,g,h,i;for(g=["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"],h=["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"],i=["1110010","1100110","1101100","1000010","1011100","1001110","1010000","1000100","1001000","1110100"],c=["xxxxxx","xxyxyy","xxyyxy","xxyyyx","xyxxyy","xyyxxy","xyyyxx","xyxyxy","xyxyyx","xyyxyx"],b="",a=c[parseInt(this.number.substr(0,1),10)].split(""),f=this.number.substr(1),e=f.split(""),d=0;6>d;)b+="x"===a[d]?g[e[d]]:h[e[d]],d++;for(d=6;12>d;)b+=i[e[d]],d++;return b},b.prototype.clear=function(a){return a.clearRect(0,0,this.element.width,this.element.height)},b.prototype.draw=function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(i={prefix_offset:.06,font_stretch:.073,border_line_height_number:.9,border_line_height:1,line_height:.9,font_size:.15,font_y:1.03,text_offset:4.5},n=this.settings.prefix?this.element.width-this.element.width*i.prefix_offset:this.element.width,this.settings.number?(c=i.border_line_height_number*this.element.height,f=i.line_height*c):(c=i.border_line_height*this.element.height,f=c),h=n/95,this.element.getContext){for(e=this.element.getContext("2d"),this.clear(e),e.fillStyle=this.settings.color,j=this.settings.number&&this.settings.prefix?this.element.width*i.prefix_offset:0,k=b.split(""),e.fillRect(j,0,h,c),j+=2*h,e.fillRect(j,0,h,c),j+=h,g=0;42>g;)"1"===k[g]&&e.fillRect(j,0,Math.floor(h)+1,f),j+=h,g++;for(j+=h,e.fillRect(j,0,h,c),j+=2*h,e.fillRect(j,0,h,c),j+=2*h,g=42;84>g;)"1"===k[g]&&e.fillRect(j,0,Math.floor(h)+1,f),j+=h,g++;if(e.fillRect(j,0,h,c),j+=2*h,e.fillRect(j,0,h,c),this.settings.number&&(e.font=i.font_size*f+"px monospace",m=this.number.substr(0,1),this.settings.prefix&&e.fillText(m,0,c*i.font_y),l=h*i.text_offset+(this.settings.prefix?i.prefix_offset*this.element.width:0),d=this.number.substr(1,6).split(""),a.each(d,function(a,b){return e.fillText(b,l,c*i.font_y),l+=i.font_stretch*n}),l=49*h+(this.settings.prefix?i.prefix_offset*this.element.width:0)+i.text_offset,a.each(this.number.substr(7).split(""),function(a,b){return e.fillText(b,l,c*i.font_y),l+=i.font_stretch*n})),this.settings.debug)for(o=p=0,q=2*h;q>0?n>=p:p>=n;o=p+=q)e.beginPath(),e.rect(o,.4*f,h,.1*f),e.fillStyle="red",e.fill();return this.settings.onSuccess.call()}return this.settings.onError.call()},b.prototype.generateCheckDigit=function(b){var c,d;return d=0,c=b.split(""),a.each(c,function(a,b){return d+=a%2===0?parseInt(b,10):3*parseInt(b,10)}),10-d%10%10},b.prototype.validate=function(){return parseInt(this.number.slice(-1),10)===this.generateCheckDigit(this.number.slice(0,-1))},b}(),a.fn[c]=function(d,e){return this.each(function(){return a.data(this,"plugin_"+c,new b(this,d,e))})}}(jQuery,window,document);